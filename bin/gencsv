#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const chalk = require('chalk');
const _ = require('lodash/string')

const Utils = require('../lib/utils');
const generator = require('../lib/generator');

const argv = require('yargs')
    .command('<file>', 'The output file name')
    .usage('$0 [options] <file> [columns..]\n$0 [options] <file> < columns.txt', {
        chunk: {
            describe: 'The number of rows to generate per pass',
            number: true,
            default: 1000
        },
        functions: {
            alias: 'func',
            describe: 'Lists available functions'
        },
        rows: {
            alias: 'r',
            describe: 'The number of rows to generate (e.g. 100, 100000, 100k, 1M, 1B, etc.)',
            default: 100
        },
        'use-headers': {
            alias: 'h',
            describe: 'Use this flag to set column headers',
            boolean: true,
            default: false
        },
        interactive: {
            alias: 'i',
            describe: 'Run the script in interactive mode with a series of questions and user-provided answers',
            conflicts: 'clear-settings'
        },
        'always-interactive': {
            alias: 'a',
            describe: 'Start the script in interactive mode and save this setting',
            conflicts: 'clear-settings'
        },
        'always-use-headers': {
            describe: 'Use this flag to persist column headers preferences',
            conflicts: 'clear-settings'
        },
        'clear-settings': {
            alias: 'c',
            describe: 'Clear always-interactive settings'
        }
    })
    .help()
    .version(require('../package.json').version)
    .argv;

if (argv.functions) {
    console.log('Available functions:');
    Utils.functions(require('../functions'));
    process.exit(0);
}

if (argv.c) {
    console.log('Removing settings...');

    try {
        fs.unlinkSync(path.resolve(Utils.home(), '.gencsv'));
        console.log(`Successfully removed ${chalk.cyan(path.resolve(Utils.home(), '.gencsv'))}`);

        if (argv._.length <= 1) {
            process.exit(0);
        }
    } catch (e) {
        console.log(`Error removing ${chalk.redBright(path.resolve(Utils.home(), '.gencsv'))}`);
        console.log('Attempting to run command...\n');
    }
}

if (Utils.isInteractive() || argv.i) {
    require('../index');
    return;
}

if (argv.a) {
    fs.writeFile(path.resolve(Utils.home(), '.gencsv'), '{ "interactive": true }', err => {
        if (err) {
            throw new Error(err);
        }

        console.log(`Settings written to ${chalk.cyan(path.resolve(Utils.home(), '.gencsv'))}`);
        setTimeout(() => require('../index'), 500);
    });

    return;
}

if (argv._.length <= 1 && process.stdin.isTTY) {
    console.log(chalk.redBright('You must define an output file name and at least one column!'));
    process.exit(1);
}

if (Utils.alwaysUseHeaders()) {
    argv['use-headers'] = true;
}

const outFile = argv._[0];
let columns = argv._.slice(1);
let rows = 100;

if (argv.r !== 100) {
    if (/^\d+(\.\d*)?(K|M|B)$/.test(argv.r)) {
        let r = argv.r.toLowerCase().trim();

        if (_.endsWith(r, 'k')) {
            rows = parseFloat(r) * 1000;
        } else if (_.endsWith(r, 'm')) {
            rows = parseFloat(r) * 10 ** 6;
        } else if (_.endsWith(r, 'b')) {
            rows = parseFloat(r) * 10 ** 9;
        }
    } else {
        if (!/[1-9]\d*/.test(argv.r)) {
            console.log(chalk.redBright('Invalid row number'));
            process.exit(1);
        }

        rows = parseInt(argv.r);
    }

    rows = Math.ceil(rows); // drop decimals if any
}

if (columns.length === 0) {
    let data = '';

    const rl = require('readline').createInterface({
        input: process.stdin,
        output: process.stdout,
        terminal: false
    });

    rl.on('line', line => {
        data += line;
        data += '\n';
    }).on('close', () => {
        console.log('Columns definitions received! Validating...');

        let lines = data.split('\n');
        let headers = '';

        if (lines.length > 2) {
            columns = lines[1].split(/\s*,\s*/);
            headers = lines[0];
        } else {
            columns = lines[0].split(/\s*,\s*/);
        }

        generate(outFile, columns, {
            rows: rows,
            chunks: argv.chunk,
            headers: argv['use-headers'] || headers.length > 0
        }, headers.split(/\s*,\s*/));
    });
} else {
    generate(outFile, columns, {
        rows: rows,
        chunks: argv.chunk,
        headers: argv['use-headers']
    });
}

function generate(file, columns, options, headers) {
    generator(file, columns, options, headers).then(() => {
        process.exit(0);
    });
}
